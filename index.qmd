---
title: "Bank Reconciliation Report"
date: today()

format:
  dashboard:
    scrolling: true
    theme: default      
    css: styles.css
include-in-header:
  - auth/header.html

css:
  - auth/auth.css

params: 
  FY: "2024-25"
  opg_bal_icici: 20299023.21
  opg_bal_vijaya: 10442601.66

execute:
  warning: false
  message: false
  echo: false
---


```{r}
#| label: load_libraries
#| include: false
library(tidyverse)
library(DBI)
library(RMySQL)
library(stringr)
library(lubridate)
library(tibble)
library(dplyr)
library(knitr)
library(reactable)
library(kableExtra)
library(bsicons)
library(bslib)
library(scales)
library(htmltools)
library(ggplot2)
library(plotly)
library(echarts4r)
```

```{r}
#| warning: false
#| include: false
#| label: db_connection

# Connect to MySQL: 
con <- dbConnect(
  RMySQL :: MySQL(),
  user = "shwetha",
  password = "Zukti@2025",
  dbname = "tally_kalpachar",
  host = "49.206.25.216",
  port = 3306
)
```

```{r}
#| warning: FALSE
#| label: load_data

daybook <- dbGetQuery(con, 
                      "SELECT *, credit_amount - debit_amount AS net_amount, '2025-26' as FY 
                      FROM vw_daybook_detailed WHERE date >= '2025-04-01';")


```

```{r}

daybook <- daybook |>
  mutate(narr_short = str_sub(narration, 1, 25))
      
```



```{r}

report_date <- as.Date("2025-12-10")
collections <- daybook %>%
  filter(voucher_type == "Receipt_New",
         date == report_date,
         net_amount < 0) %>%
  select(date, voucher_type, ledger_name, narr_short, net_amount)
payables <- daybook %>%
  filter(voucher_type== "Payment_New",
         date == report_date,
         net_amount > 0) %>%
  select(date, voucher_type, ledger_name, narr_short, net_amount)

```

# BRS



```{r}
icici_books <- daybook |> 
  filter(ledger_name == "11101004 - ICICI bank-281305008509") |> 
  group_by(m = month(date)) |> 
  summarise(bal = sum(net_amount, na.rm = TRUE)) %>%
  rbind(data.frame(m = 0, bal = params$opg_bal_icici),.) |>  
  mutate(closing_bal = cumsum(bal)) %>%
  pull(closing_bal) |> 
  tail(1)

vijaya_books <- daybook |> 
  filter(ledger_name == "11101002 -   VIjaya Bank -100800301000084") |> 
  group_by(m = month(date)) |> 
  summarise(bal = sum(net_amount, na.rm = TRUE)) %>%
  rbind(data.frame(m = 0, bal = params$opg_bal_vijaya),.) |>  
  mutate(closing_bal = cumsum(bal)) %>%
  pull(closing_bal) |> 
  tail(1)


```

## Row
```{r}

total_collections <- sum(collections$net_amount, na.rm = TRUE) * -1
total_payments    <- sum(payables$net_amount, na.rm = TRUE)


opening_icici <- params$opg_bal_icici

txn_icici <- daybook |>
  filter(ledger_name == "11101004 - ICICI bank-281305008509") |>
  summarise(total = sum(net_amount, na.rm = TRUE)) |>
  pull(total)


closing_icici <- opening_icici + txn_icici


opening_vijaya <- params$opg_bal_vijaya

txn_vijaya <- daybook |>
  filter(ledger_name == "11101002 -   VIjaya Bank -100800301000084") |>
  summarise(total = sum(net_amount, na.rm = TRUE)) |>
  pull(total)


closing_vijaya <- opening_vijaya + txn_vijaya

```

## Row

### Column 1

```{r}

  value_box(
  title = tags$span(style="font-size:0.7rem;", "Total Collections"),
  value = tags$span(style="font-size:0.9rem;", paste0("₹ ", comma(total_collections))),
  showcase = bs_icon("cash-stack", size="1em"),
  style = "background-color: #89c7a1; color: #61615f; border-radius:0.5rem;",
  showcase_layout = "left center"
)

  tags$div(
  `data-bs-toggle` = "tooltip",
  `data-bs-placement` = "right",
  title = paste0(
    "Opening Balance : ₹ ", comma(opening_icici), "\n",
    "Net Transactions : ₹ ", comma(txn_icici), "\n",
    "-------------------------\n",
    "Closing Balance : ₹ ", comma(icici_books)
  ),
  style = "cursor: help;",

  value_box(
    title = tags$span(style="font-size:0.7rem;", "ICICI Balance"),
    value = tags$span(style="font-size:0.9rem;", paste0("₹ ", comma(icici_books))),
    showcase = bs_icon("bank", size="1em"),
    style = "background-color: #6395d6; color: #61615f; border-radius:0.5rem;",
    showcase_layout = "left center"
  )
)

```

### Column 2

```{r}
# Total Payments Card
  value_box(
    title = tags$span(style="font-size:0.7rem;", "Total Payments"),
    value = tags$span(style="font-size:0.9rem;", paste0("₹ ", comma(total_payments))),
    showcase = bs_icon("credit-card", size="1em"),
    style = "background-color: #e68273; color: #61615f; border-radius:0.5rem;",
    showcase_layout = "left center"
  )
  

  # Vijaya Balance Card
  tags$div(
  `data-bs-toggle` = "tooltip",
  `data-bs-placement` = "right",
  title = paste0(
    "Opening Balance : ₹ ", comma(opening_vijaya), "\n",
    "Net Transactions : ₹ ", comma(txn_vijaya), "\n",
    "-------------------------\n",
    "Closing Balance : ₹ ", comma(closing_vijaya)
  ),
  style = "cursor: help;",

  value_box(
    title = tags$span(style="font-size:0.7rem;", "Vijaya Balance"),
    value = tags$span(style="font-size:0.9rem;", paste0("₹ ", comma(closing_vijaya))),
    showcase = bs_icon("piggy-bank", size="1em"),
    style = "background-color: #dfe378; color: #61615f; border-radius:0.5rem;",
    showcase_layout = "left center"
  )
)

```

### Column 3
```{r}
cashflow_df <- tibble(
  Type = c("Collections", "Payments"),
  Amount = c(total_collections, total_payments)
)

cashflow_df$Amount <- as.numeric(cashflow_df$Amount)

cashflow_df |>
  e_charts(Type) |>
  e_bar(
    Amount,
    width = "50%",
    itemStyle = list(
      color = htmlwidgets::JS(
        "function(params){
           return params.name === 'Collections'
           ? '#89c7a1'
           : '#e68273';
         }"
      )
    )
  ) |>
  e_title("Collections vs Payments") |>
  e_y_axis(
    name = "Amount (₹)",
    axisLabel = list(
      formatter = htmlwidgets::JS(
        "function(value){
           return value.toLocaleString();
         }"
      )
    )
  ) |>
  e_tooltip(
    trigger = "axis",
    formatter = htmlwidgets::JS(
      "function(params){
         return params[0].name + ': ₹' +
                params[0].value.toLocaleString();
       }"
    )
  ) |>
  e_legend(FALSE) |> 
  e_grid(left = 60, right = 30, top = 60, bottom = 40)|> e_animation(duration = 800)



```


## Row

### Column 1
```{r}

monthly_movement <- daybook %>%
  filter(ledger_name %in% c(
    "11101004 - ICICI bank-281305008509",
    "11101002 - VIjaya Bank -100800301000084"
  )) %>%
  mutate(
    date = as.Date(date, format = "%Y-%m-%d"),
    Month = floor_date(date, "month")
  ) %>%
  group_by(Month, ledger_name) %>%
  summarise(Net = sum(net_amount), .groups = "drop") %>%
  arrange(ledger_name, Month)

monthly_movement$Net <- as.numeric(monthly_movement$Net)

# Color mapping for each ledger
color_map <- c("11101004 - ICICI bank-281305008509" = "#a6dca1ff",   # ICICI blue
               "11101002 - VIjaya Bank -100800301000084" = "#ff7f0e") # Vijaya orange

# Generate the line chart with custom colors
monthly_movement %>%
  group_by(ledger_name) %>%
  e_charts(Month) %>%
  e_line(
    Net,
    symbol = "circle",
    symbolSize = 8,
    itemStyle = list(
      color = htmlwidgets::JS(
        "function(params) {
           // Use the color_map to assign colors based on ledger_name
           var colorMap = {'11101004 - ICICI bank-281305008509': '#27ab1eff', 
                           '11101002 - VIjaya Bank -100800301000084': '#ff7f0e'};
           return colorMap[params.name] || '#888';  // Fallback color
         }"
      )
    )
  ) %>%
  e_title("Monthly Bank Movement") %>%
  e_y_axis(
    name = "Net Amount (₹)",
    axisLabel = list(
      formatter = htmlwidgets::JS(
        "function(value){
           return value.toLocaleString('en-IN');
         }"
      )
    )
  ) %>%
  e_tooltip(
    trigger = "axis",
    formatter = htmlwidgets::JS(
      "function(params){
         var txt = '';
         params.forEach(function(p){
           var month = new Date(p.value[0])
             .toLocaleDateString('en-IN', { month: 'short', year: 'numeric' });
           var net = p.value[1].toLocaleString('en-IN');
           txt += '<b>Ledger:</b> ' + p.seriesName +
                  '<br><b>Month:</b> ' + month +
                  '<br><b>Net:</b> ₹' + net +
                  '<br><br>';
         });
         return txt;
       }"
    )
  ) %>%
  e_legend(TRUE)


```

### Column 2
```{r}

bank_balance_df <- tibble(
  Bank = c("ICICI", "Vijaya"),
  Balance = c(icici_books, vijaya_books)
)

bank_balance_df$Balance <- as.numeric(bank_balance_df$Balance)

bank_balance_df %>%
  e_charts(Bank) %>%
  e_bar(
    Balance,
    itemStyle = list(
      color = htmlwidgets::JS(
        "function(params){
           return params.name === 'ICICI'
           ? '#6395d6'
           : '#dfe378';
         }"
      )
    )
  ) %>%
  e_title("Closing Balance Comparison") %>%
  e_y_axis(
    name = "Balance (₹)",
    axisLabel = list(
      formatter = htmlwidgets::JS(
        "function(value){
           return value.toLocaleString('en-IN');
         }"
      )
    )
  ) %>%
  e_tooltip(
  trigger = "item",
  formatter = htmlwidgets::JS(
    "function(p){
       return `
         <table style='width:100%; font-size:12px'>
           <tr>
             <td style='padding-right:10px;'><b>Bank</b></td>
             <td style='text-align:right;'>${p.name}</td>
           </tr>
           <tr>
             <td><b>Balance</b></td>
             <td style='text-align:right;'>₹${p.value.toLocaleString('en-IN')}</td>
           </tr>
         </table>
       `;
     }"
  )
) %>%
  e_legend(FALSE)

```



## Row

### Column 1

```{r}
#This Will Get BankWise Credit And Debit Data
bank_dc_split <- daybook %>%
  filter(ledger_name %in% c(
    "11101004 - ICICI bank-281305008509",
    "11101002 -   VIjaya Bank -100800301000084"
  )) %>%
  summarise(
    Credit = sum(credit_amount, na.rm = TRUE),
    Debit  = sum(debit_amount, na.rm = TRUE),
    .by = ledger_name
  ) %>%
  pivot_longer(
    cols = c(Credit, Debit),
    names_to = "Type",
    values_to = "Amount"
  )

```

```{r}
library(dplyr)
library(echarts4r)

icici_dc <- bank_dc_split %>%
  filter(ledger_name == "11101004 - ICICI bank-281305008509")

icici_dc %>%
  e_charts(Type) %>%
  e_pie(
    Amount,
    radius = c("55%", "75%"),   # donut shape
    label = list(
      formatter = "{b}: {d}%"   # label + percent
    )
  ) %>%
  e_tooltip(
    trigger = "item",
    formatter = htmlwidgets::JS(
      "function(params) {
         return '<b>' + params.name + '</b><br/>' +
                'Amount: ₹ ' + params.value.toLocaleString();
       }"
    )
  ) %>%
  e_title("ICICI Bank – Debit vs Credit") %>%
  e_legend(right = "5%")

```


### Column 2

```{r}
library(dplyr)
library(echarts4r)

vijaya_dc <- bank_dc_split %>%
  filter(ledger_name == "11101002 -   VIjaya Bank -100800301000084") %>%
  transmute(
    name  = Type,     # REQUIRED by ECharts
    value = Amount    # REQUIRED by ECharts
  )

e_charts() %>%
  e_pie(
    vijaya_dc,
    name = "Debit vs Credit",
    radius = c("55%", "75%"),
    label = list(
      formatter = "{b}: {d}%"
    )
  ) %>%
  e_tooltip(
    formatter = htmlwidgets::JS(
      "function(params) {
         return '<b>' + params.name + '</b><br/>' +
                'Amount: ₹ ' + params.value.toLocaleString();
       }"
    )
  ) %>%
  e_title("Vijaya Bank – Debit vs Credit") %>%
  e_legend(show = TRUE)

```

### Column 3 {width=50%}

```{r}
library(dplyr)
library(lubridate)
library(echarts4r)
library(scales)

txn_movement <- daybook %>%
  filter(ledger_name %in% c(
    "11101004 - ICICI bank-281305008509",
    "11101002 - VIjaya Bank -100800301000084"
  )) %>%
  mutate(
    date = as.Date(date),
    Month = floor_date(date, "month")
  ) %>%
  arrange(ledger_name, date)

# echarts4r plot: one line per bank using group_by()
txn_movement %>%
  group_by(ledger_name) %>%         # group by bank
  e_charts(date) %>%
  e_line(
    net_amount,
    symbol = "circle",
    symbol_size = 8,
    smooth = FALSE
  ) %>%
  e_tooltip(
    trigger = "item",
    formatter = htmlwidgets::JS(
      "function(params) {
         return '<b>Bank:</b> ' + params.seriesName + '<br/>' +
                '<b>Date:</b> ' + params.value[0] + '<br/>' +
                '<b>Amount:</b> ₹ ' + params.value[1].toLocaleString();
       }"
    )
  ) %>%
  e_title("Transaction-wise Bank Movement (Each Record)") %>%
  e_x_axis(name = "Date") %>%
  e_y_axis(
    name = "Transaction Amount (₹)",
    axisLabel = list(formatter = JS("function(val){return val.toLocaleString();}")),
    zeroline = TRUE
  ) %>%
  e_legend(right = "5%")


```




## Row
```{r}
library(reactable)
library(dplyr)
library(stringr)
library(htmltools)
library(htmlwidgets)
library(readr)

report_date_fmt <- format(as.Date(report_date), "%d-%b-%Y")

# Indian Rupee Formatter

format_inr <- function(x) {
  x <- as.numeric(x)

  ifelse(
    is.na(x),
    "-",
    {
      s <- as.character(round(x))
      last3 <- substr(s, nchar(s) - 2, nchar(s))
      rest  <- substr(s, 1, nchar(s) - 3)

      ifelse(
        nchar(rest) > 0,
        paste0(gsub("(\\d)(?=(\\d{2})+$)", "\\1,", rest, perl = TRUE), ",", last3),
        last3
      )
    }
  )
}


bank_table <- tribble(
  ~`Bank Name`,            ~`Account No`,          ~Status,    ~`Balance as per Books`, ~`Cheque issued but not yet presented`, ~`Cheques Received but not yet deposited`, ~`Balance as per Bank`,
  "Bank of Baroda",        "50060200000389",       "Active",    "5,076,886",             "-",                                        "-",                                        "5,076,886",
  "ICICI Bank",            "281305008509",         "Active",    format(icici_books, big.mark=","), "-", "-", format(icici_books, big.mark=","),

  "Bank of Baroda",        "100800301000131",      "Inactive",  "3,719",                  "-", "-", "Not Provided",

  "State Bank of India",   "00000031065154819",    "Inactive",  "37,229",                 "-", "-", "Not Provided",

  "Bank of Baroda (Vijaya)", "100800301000084",    "Inactive",   format(vijaya_books, big.mark=","), "-", "-", "Not Provided",

  "Bank of Baroda OD",     "OD",                   "Inactive",  "-",                      "-", "-", "-",
)

# Numeric Conversion

bank_table_num <- bank_table %>%
  mutate(
    books_num    = parse_number(`Balance as per Books`),
    issued_num   = parse_number(`Cheque issued but not yet presented`),
    received_num = parse_number(`Cheques Received but not yet deposited`),
    bank_num     = parse_number(`Balance as per Bank`)
  )

# Column Totals

books_sum    <- sum(bank_table_num$books_num, na.rm = TRUE)
issued_sum   <- sum(bank_table_num$issued_num, na.rm = TRUE)
received_sum <- sum(bank_table_num$received_num, na.rm = TRUE)
bank_sum     <- sum(bank_table_num$bank_num, na.rm = TRUE)


# Display Table (Indian Format)

bank_table_display <- bank_table_num %>%
  mutate(
    `Balance as per Books` =
      format_inr(books_num),

    `Cheque issued but not yet presented` =
      format_inr(issued_num),

    `Cheques Received but not yet deposited` =
      format_inr(received_num),

    `Balance as per Bank` =
      format_inr(bank_num)
  ) %>%
  select(-books_num, -issued_num, -received_num, -bank_num)



reactable(
  bank_table_display,
  searchable = TRUE,
  defaultPageSize = 10,
  striped = TRUE,
  bordered = TRUE,
  wrap = FALSE,
  elementId = "bank_reco_table",

  columns = list(
    `Bank Name` = colDef(footer = "Total"),

    `Balance as per Books` = colDef(
      align = "right",
      footer = paste0("₹ ", format_inr(books_sum))
    ),

    `Cheque issued but not yet presented` = colDef(
      align = "right",
      footer = paste0("₹ ", format_inr(issued_sum))
    ),

    `Cheques Received but not yet deposited` = colDef(
      align = "right",
      footer = paste0("₹ ", format_inr(received_sum))
    ),

    `Balance as per Bank` = colDef(
      align = "right",
      footer = paste0("₹ ", format_inr(bank_sum))
    )
  ),

  rowStyle = JS("function(rowInfo) {
    return { backgroundColor: '#ffffff' };
  }"),

  theme = reactableTheme(
    headerStyle = list(
      backgroundColor = "#DCE6F1",
      fontWeight = "bold",
      textAlign = "center"
    ),
    footerStyle = list(
      backgroundColor = "#DCE6F1",
      fontWeight = "bold"
    )
  )
) |>
onRender(
  paste0("
    function(el) {

      const table = el.querySelector('.rt-table');
      if (table) {
        table.style.border = '1px solid #d1d5db';
      }

      const search = el.querySelector('.rt-search');
      if (search && !document.getElementById('bank-report-title')) {

        const title = document.createElement('div');
        title.id = 'bank-report-title';
        title.innerHTML = 'Bank Reconciliation Statement as on ", report_date_fmt, "';

        title.style.background = '#DCE6F1';
        title.style.padding = '10px';
        title.style.textAlign = 'center';
        title.style.fontWeight = 'bold';
        title.style.fontSize = '1.1rem';
        title.style.border = '1px solid #d1d5db';
        title.style.borderBottom = 'none';
        title.style.marginTop = '8px';

        search.parentNode.insertBefore(title, search.nextSibling);
      }
    }
  ")
)

```

# Collections Report

```{r, results='asis'}
 library(reactable)
library(dplyr)
library(htmlwidgets)

collections_final <- collections %>%
  rename(
    Date = date,
    `Voucher Type` = voucher_type,
    `Party Name` = ledger_name,
    `Bank Ref` = narr_short,
    Amount = net_amount
  )

total_amount <- sum(collections_final$Amount, na.rm = TRUE)

reactable(
  collections_final,
  searchable = TRUE,
  resizable = TRUE,
  wrap = FALSE,
  striped = TRUE,
  bordered = TRUE,
  elementId = "collections_table",

  defaultPageSize = 10,
  showPageSizeOptions = TRUE,
  pageSizeOptions = c(10, 25, 50),

  columns = list(

    `Party Name` = colDef(
      footer = "Total",
      footerStyle = list(
        fontWeight = "bold",
        textAlign = "left"
      )
    ),

    Amount = colDef(
      align = "right",

      format = colFormat(
        digits = 2,
        separators = TRUE,
        locales = "en-IN"
      ),

      footer = JS(sprintf(
        "new Intl.NumberFormat('en-IN', { minimumFractionDigits: 2 }).format(%f)",
        total_amount
      )),

      footerStyle = list(
        fontWeight = "bold",
        textAlign = "right"
      )
    )
  ),

  rowStyle = JS("
    function(rowInfo) {
      return { backgroundColor: '#ffffff' };
    }
  "),

  theme = reactableTheme(
    headerStyle = list(
      backgroundColor = '#DCE6F1',
      color = '#111827',
      fontWeight = 'bold',
      textAlign = 'center'
    ),
    footerStyle = list(
      backgroundColor = '#DCE6F1',
      fontWeight = 'bold',
      borderTop = '2px solid #111827'
    )
  )
) |>
onRender(
  paste0("
    function(el) {

      const table = el.querySelector('.rt-table');
      if (table) {
        table.style.border = '1px solid #d1d5db';
      }

      
      const search = el.querySelector('.rt-search');

      if (search && !document.getElementById('collections-report-title')) {

        const title = document.createElement('div');
        title.id = 'collections-report-title';
        title.innerHTML = 'Collections Report as on ", report_date_fmt, "';

        title.style.background = '#DCE6F1';
        title.style.padding = '10px';
        title.style.textAlign = 'center';
        title.style.fontWeight = 'bold';
        title.style.fontSize = '1.1rem';
        title.style.border = '1px solid #d1d5db';
        title.style.borderBottom = 'none';
        title.style.marginTop = '8px';

        search.parentNode.insertBefore(title, search.nextSibling);
      }
    }
  ")
)


```

# Payment Report

```{r, results='asis'}
library(reactable)
library(dplyr)
library(htmlwidgets)

payables_final <- payables %>%
  rename(
    Date = date,
    `Voucher Type` = voucher_type,
    `Bank Ref` = narr_short,
    `Party Name` = ledger_name,
    Amount = net_amount
  )

amount_total <- sum(payables_final$Amount, na.rm = TRUE)

reactable(
  payables_final,
  searchable = TRUE,
  resizable = TRUE,
  wrap = FALSE,
  striped = TRUE,
  bordered = TRUE,
  elementId = "payments_table",

  defaultPageSize = 10,
  showPageSizeOptions = TRUE,
  pageSizeOptions = c(10, 25, 50),

  columns = list(

    `Party Name` = colDef(
      footer = "Total",
      footerStyle = list(
        fontWeight = "bold",
        textAlign = "left"
      )
    ),

    Amount = colDef(
      align = "right",

      format = colFormat(
        digits = 2,
        separators = TRUE,
        locales = "en-IN"
      ),

      footer = JS(sprintf(
        "new Intl.NumberFormat('en-IN', { minimumFractionDigits: 2 }).format(%f)",
        amount_total
      )),

      footerStyle = list(
        fontWeight = "bold",
        textAlign = "right"
      )
    )
  ),

  rowStyle = JS("
    function(rowInfo) {
      return { backgroundColor: '#ffffff' };
    }
  "),

  theme = reactableTheme(
    headerStyle = list(
      backgroundColor = '#DCE6F1',
      color = '#111827',
      fontWeight = 'bold',
      textAlign = 'center'
    ),
    footerStyle = list(
      backgroundColor = '#DCE6F1',
      fontWeight = 'bold',
      borderTop = '2px solid #111827'
    ),
    stripedColor = "#ffffff"
  )
) |>
onRender(
  paste0("
    function(el) {

      /* ADD OUTER BORDER */
      const table = el.querySelector('.rt-table');
      if (table) {
        table.style.border = '1px solid #d1d5db';
      }

      /* ADD TITLE BELOW SEARCH */
      const search = el.querySelector('.rt-search');

      if (search && !document.getElementById('payments-report-title')) {

        const title = document.createElement('div');
        title.id = 'payments-report-title';
        title.innerHTML = 'Payments Report as on ", report_date_fmt, "';

        title.style.background = '#DCE6F1';
        title.style.padding = '10px';
        title.style.textAlign = 'center';
        title.style.fontWeight = 'bold';
        title.style.fontSize = '1.1rem';
        title.style.border = '1px solid #d1d5db';
        title.style.borderBottom = 'none';
        title.style.marginTop = '8px';

        search.parentNode.insertBefore(title, search.nextSibling);
      }
    }
  ")
)


```










